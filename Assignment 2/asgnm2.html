<!DOCTYPE html>
<!--Jonathan Wu
CS 4803 visualization Assignment 1
Conway's Game of Life-->
<html>
<head>
</head>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>

<script>
var margin = {top: 20, right: 120, bottom: 20, left: 120},
 width = 960 - margin.right - margin.left,
 height = 500 - margin.top - margin.bottom;
 
var i = 0;

var tree = d3.layout.tree()
 .size([height, width]);

var diagonal = d3.svg.diagonal()
 .projection(function(d) { return [d.y, d.x]; });

var svg = d3.select("body").append("svg")
 .attr("width", width + margin.right + margin.left)
 .attr("height", height + margin.top + margin.bottom)
  .append("g")
 .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
 
var rows;
var dups;

var treeList = [];

d3.csv("zoodata.csv", function(loadedRows) {
  rows = loadedRows;
  doSomethingWithRows();
});

function doSomethingWithRows() {
  // do something with rows
	console.log(rows);
	generateTree();
	console.log(rows);
	root = rows[0];
	update(root);
}
function update(source) {

  // Compute the new tree layout.
  var nodes = tree.nodes(root).reverse(),
   links = tree.links(nodes);

  // Normalize for fixed-depth.
  nodes.forEach(function(d) { d.y = d.depth * 180; });

  // Declare the nodesâ€¦
  var node = svg.selectAll("g.node")
   .data(nodes, function(d) { return d.id || (d.id = ++i); });

  // Enter the nodes.
  var nodeEnter = node.enter().append("g")
   .attr("class", "node")
   .attr("transform", function(d) { 
    return "translate(" + d.y + "," + d.x + ")"; });

  nodeEnter.append("circle")
   .attr("r", 10)
   .style("fill", "#fff");

  nodeEnter.append("text")
   .attr("x", function(d) { 
    return d.children || d._children ? -13 : 13; })
   .attr("dy", ".35em")
   .attr("text-anchor", function(d) { 
    return d.children || d._children ? "end" : "start"; })
   .text(function(d) { return d.name; })
   .style("fill-opacity", 1);

  // Declare the links
  var link = svg.selectAll("path.link")
   .data(links, function(d) { return d.target.id; });

  // Enter the links
  link.enter().insert("path", "g")
   .attr("class", "link")
   .attr("d", diagonal);

}
//sorts the data from rows into tree

function generateTree(){
	//load animals into tree
	for(var i = 0; i<rows.length; i++){
		var Node = {aniList:null, child1:null, child2:null};
		Node.aniList = [];
		Node.aniList.push(rows[i]);
		treeList.push(Node);
	}
	//combine duplicate animals
	for(var i = 0; i<treeList.length; i++){
		for(var j = i+1; j<treeList.length; j++){
			console.log(distance(treeList[i],treeList[j]));
			if(distance(treeList[i],treeList[j]) == 0){
				treeList[i].aniList.push(treeList[j].aniList[0]);
				treeList.splice(j,1);
				j--;
			}
		}
	}
	console.log(treeList);
	//while(rows.length > 1){
	for(var test = 0; test<10; test++){	
		var dist = 999999;
		var indexA;
		var indexB;
		//find lowest distance
		for(var i = 0; i<rows.length; i++){
			for(var j = i+1; j<rows.length; j++){
				//console.log(distance(rows[i],rows[j]));
				if(distance(rows[i],rows[j]) < dist){
					dist = distance(rows[i],rows[j]);
					indexA = i;
					indexB = j;
				}
				
			}
		}
		
		//create new object with indexA and indexB
		//remove indexA and indexB
		var n1 = rows[indexA];
		var n2 = rows[indexB];
		rows.push(new Animal(n1, n2, averageAnimal(n1, n2), dist));
		rows.splice(indexB,1);
		rows.splice(indexA,1);
		
	}
}

//calculate distance between animals
function distance(animal1, animal2) {
    var distance = 0;
    // loop through, skipping the 'name' and 'type' columns
	for (key in animal1) {
		//if(animal1.hasOwnProperty(key)){
			if (animal1[key] != animal2[key]) {
				console.log(animal1[key]);
				distance+=1;
			}
		//}
	}
	//console.log(distance);
	return distance;
    //return Math.pow(distance, 0.5);
}
// a data structure to store animals and clusters as
function Animal(child1, child2, animal, distance) {
    // if the two nodes are exactly the same (except for name) combine them
    // instead of making a parent with two children
    if (distance == 0 && child1) {
        this.child1 = null;
        this.child2 = null;
        this.animal = animal;
        this.animal[0] = child1[0] + "\\n" + child2[0];
        this.distance = distance;
    } else {
        this.child1 = child1;
        this.child2 = child2;
        this.animal = animal;
        this.distance = distance;
        this.height = 0;
    }
}
Animal.prototype.toJSON = function () { 
    return "{" + "\"name\":\"" + this.animal[0] + "\",\"height\":" + this.height + 
    ",\"children\":[" + 
    (this.child1 ? this.child1.toJSON() + "," : "") + 
    (this.child2 ? this.child2.toJSON() : "") + "]}";
};
// average two animals
function averageAnimal(a1, a2) {
    var result = a1;
    result[0] = a1[0] + "\\n" + a2[0];
    for (var i = 1; i < a1.length; i++) {
        result[i] = a1[i] / 2 + a2[i] / 2;
    }
    return result;
}


</script>


</body>
</html>